<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Профиль - UGC PRO</title>
    <link rel="stylesheet" href="css/profile.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        .profile-container {
            padding-bottom: 80px; /* Отступ для фиксированной кнопки */
        }
        
        .fixed-button-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--tg-theme-bg-color, #fff);
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        
        .save-button {
            width: 100%;
            padding: 12px;
            background: var(--tg-theme-button-color, #007bff);
            color: var(--tg-theme-button-text-color, #fff);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .save-button:active {
            opacity: 0.8;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            font-size: 16px; /* Оптимальный размер для предотвращения зума на iOS */
        }
    </style>
</head>
<body>
    <div class="profile-container">
        <h1>Профиль пользователя</h1>
        <form id="profile-form">
            <!-- Основная информация -->
            <div class="form-group">
                <label for="name">Имя</label>
                <input type="text" id="name" name="name" required>
            </div>

            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" required>
            </div>

            <div class="form-group">
                <label for="phone">Телефон</label>
                <input type="tel" id="phone" name="phone">
            </div>

            <div class="form-group">
                <label for="telegram">Telegram</label>
                <input type="text" id="telegram" name="telegram">
            </div>

            <div class="form-group">
                <label for="role">Роль</label>
                <select id="role" name="role" required>
                    <option value="blogger">Блогер</option>
                    <option value="brand">Бренд</option>
                </select>
            </div>

            <!-- Категории -->
            <div class="form-group">
                <label>Категории</label>
                <div class="categories-grid">
                    <label class="category-item">
                        <input type="checkbox" name="categories" value="beauty">
                        <span>Красота</span>
                    </label>
                    <label class="category-item">
                        <input type="checkbox" name="categories" value="fashion">
                        <span>Мода</span>
                    </label>
                    <label class="category-item">
                        <input type="checkbox" name="categories" value="lifestyle">
                        <span>Лайфстайл</span>
                    </label>
                    <label class="category-item">
                        <input type="checkbox" name="categories" value="tech">
                        <span>Технологии</span>
                    </label>
                    <label class="category-item">
                        <input type="checkbox" name="categories" value="food">
                        <span>Еда</span>
                    </label>
                    <label class="category-item">
                        <input type="checkbox" name="categories" value="travel">
                        <span>Путешествия</span>
                    </label>
                    <label class="category-item">
                        <input type="checkbox" name="categories" value="sport">
                        <span>Спорт</span>
                    </label>
                </div>
            </div>

            <!-- Поля для блогера -->
            <div class="role-specific blogger-fields">
                <div class="form-group">
                    <label for="description">О себе</label>
                    <textarea id="description" name="description"></textarea>
                </div>

                <div class="form-group">
                    <label for="audience">Количество подписчиков</label>
                    <input type="number" id="audience" name="audience">
                </div>

                <div class="form-group">
                    <label for="price">Стоимость размещения (₽)</label>
                    <input type="number" id="price" name="price">
                </div>
            </div>

            <!-- Поля для бренда -->
            <div class="role-specific brand-fields">
                <div class="form-group">
                    <label for="company">Название компании</label>
                    <input type="text" id="company" name="company">
                </div>

                <div class="form-group">
                    <label for="website">Сайт</label>
                    <input type="url" id="website" name="website">
                </div>
            </div>
        </form>
    </div>

    <!-- Фиксированная кнопка сохранения -->
    <div class="fixed-button-container">
        <button id="save-button" class="save-button">Сохранить изменения</button>
    </div>

    <script>
        // Функция для сохранения данных
        function saveProfileData() {
            // Собираем все данные из формы
            const formData = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                telegram: document.getElementById('telegram').value,
                role: document.getElementById('role').value,
                description: document.getElementById('description').value,
                audience: document.getElementById('audience').value,
                price: document.getElementById('price').value,
                company: document.getElementById('company').value,
                website: document.getElementById('website').value,
                categories: Array.from(document.querySelectorAll('input[name="categories"]:checked'))
                    .map(checkbox => checkbox.value),
                isRegistered: true
            };

            // Сохраняем в localStorage
            try {
                localStorage.setItem('userData', JSON.stringify(formData));
                console.log('Saved data:', formData);
                return true;
            } catch (error) {
                console.error('Error saving data:', error);
                return false;
            }
        }

        // Функция для загрузки данных
        function loadProfileData() {
            try {
                const savedData = localStorage.getItem('userData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    console.log('Loading data:', data);

                    // Заполняем все поля
                    document.getElementById('name').value = data.name || '';
                    document.getElementById('email').value = data.email || '';
                    document.getElementById('phone').value = data.phone || '';
                    document.getElementById('telegram').value = data.telegram || '';
                    document.getElementById('role').value = data.role || 'blogger';
                    document.getElementById('description').value = data.description || '';
                    document.getElementById('audience').value = data.audience || '';
                    document.getElementById('price').value = data.price || '';
                    document.getElementById('company').value = data.company || '';
                    document.getElementById('website').value = data.website || '';

                    // Отмечаем категории
                    if (data.categories && Array.isArray(data.categories)) {
                        document.querySelectorAll('input[name="categories"]').forEach(checkbox => {
                            checkbox.checked = data.categories.includes(checkbox.value);
                        });
                    }

                    // Показываем/скрываем поля в зависимости от роли
                    toggleRoleFields(data.role);
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Функция переключения полей в зависимости от роли
        function toggleRoleFields(role) {
            const bloggerFields = document.querySelector('.blogger-fields');
            const brandFields = document.querySelector('.brand-fields');

            if (role === 'blogger') {
                bloggerFields.style.display = 'block';
                brandFields.style.display = 'none';
            } else {
                bloggerFields.style.display = 'none';
                brandFields.style.display = 'block';
            }
        }

        // Обработчик изменения роли
        document.getElementById('role').addEventListener('change', function(e) {
            toggleRoleFields(e.target.value);
        });

        // Обработчик нажатия кнопки сохранения
        document.getElementById('save-button').addEventListener('click', function() {
            if (saveProfileData()) {
                alert('Профиль успешно сохранен!');
                
                // Обновляем данные в родительском окне
                if (window.opener && window.opener.updateUserData) {
                    window.opener.updateUserData();
                }
                
                // Если это Telegram WebApp
                if (window.Telegram?.WebApp) {
                    window.Telegram.WebApp.MainButton.setText('Профиль сохранен').show();
                    setTimeout(() => {
                        window.Telegram.WebApp.MainButton.hide();
                    }, 2000);
                }
                
                // Перезагружаем страницу для применения изменений
                window.location.reload();
            } else {
                alert('Произошла ошибка при сохранении профиля');
            }
        });

        // Загружаем данные при загрузке страницы
        window.addEventListener('load', function() {
            loadProfileData();
            
            // Интеграция с Telegram WebApp
            if (window.Telegram?.WebApp) {
                const webApp = window.Telegram.WebApp;
                webApp.ready();
                
                if (webApp.colorScheme === 'dark') {
                    document.documentElement.setAttribute('data-theme', 'dark');
                }
            }
        });

        // Обработчики для сворачивания клавиатуры
        document.querySelectorAll('input, textarea, select').forEach(element => {
            element.addEventListener('blur', function() {
                window.scrollTo(0, 0);
            });
        });

        // Сворачиваем клавиатуру при тапе вне полей ввода
        document.addEventListener('click', function(e) {
            if (!e.target.matches('input, textarea, select, label')) {
                document.activeElement.blur();
            }
        });
    </script>
</body>
</html>
